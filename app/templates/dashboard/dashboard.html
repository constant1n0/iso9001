<!-- 
# Este archivo es parte de "ABSOLUT ISO9001".
#
# "ABSOLUT ISO9001" es software libre: puede redistribuirlo y/o modificarlo
# bajo los términos de la Licencia Pública General GNU publicada por la
# Free Software Foundation, ya sea la versión 3 de la Licencia o (a su
# elección) cualquier versión posterior.
#
# "ABSOLUT ISO9001" se distribuye con la esperanza de que sea útil,
# pero SIN NINGUNA GARANTÍA; incluso sin la garantía implícita de
# COMERCIABILIDAD o IDONEIDAD PARA UN PROPÓSITO PARTICULAR. Consulte la
# Licencia Pública General GNU para obtener más detalles.
#
# Debería haber recibido una copia de la Licencia Pública General GNU
# junto con este programa. En caso contrario, consulte <https://www.gnu.org/licenses/>.
 -->
{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h2>Panel de Control - Sistema de Gestión de Calidad</h2>

<div class="statistics">
    <p><strong>Total de Auditorías:</strong> {{ total_auditorias }}</p>
    <p><strong>Total de No Conformidades:</strong> {{ total_no_conformidades }}</p>
    <p><strong>Promedio de Satisfacción del Cliente:</strong> {{ promedio_satisfaccion | round(2) }}</p>
    <p><strong>Total de Capacitaciones:</strong> {{ total_capacitaciones }}</p>
</div>

<div class="notifications">
    <h3>Notificaciones</h3>
    
    <!-- Auditorías Próximas -->
    <h4>Auditorías Próximas en los Próximos 7 Días</h4>
    {% if proximas_auditorias %}
        <ul>
            {% for auditoria in proximas_auditorias %}
                <li>
                    Auditoría en {{ auditoria.area_auditada }} - Fecha: {{ auditoria.fecha.strftime('%Y-%m-%d') }}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay auditorías programadas en los próximos 7 días.</p>
    {% endif %}
    
    <!-- No Conformidades Abiertas -->
    <h4>No Conformidades Abiertas</h4>
    {% if no_conformidades_pendientes %}
        <ul>
            {% for nc in no_conformidades_pendientes %}
                <li>{{ nc.descripcion }} - Responsable: {{ nc.responsable or "No asignado" }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay no conformidades abiertas.</p>
    {% endif %}
    
    <!-- Capacitaciones Próximas -->
    <h4>Capacitaciones Próximas en los Próximos 30 Días</h4>
    {% if proximas_capacitaciones %}
        <ul>
            {% for capacitacion in proximas_capacitaciones %}
                <li>
                    Capacitación: {{ capacitacion.tema }} - Fecha: {{ capacitacion.fecha.strftime('%Y-%m-%d') }} - Personal: {{ capacitacion.personal }}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay capacitaciones próximas a vencer en los próximos 30 días.</p>
    {% endif %}
</div>

<div class="charts">
    <h3>Gráfico de No Conformidades</h3>
    <canvas id="noConformidadesChart" style="margin-bottom: 20px;"></canvas>
</div>

<div class="charts">
    <h3>Gráfico de Satisfacción del Cliente</h3>
    <canvas id="satisfaccionChart"></canvas>
</div>

<script>
    // Configuración del gráfico de No Conformidades
    var ctx = document.getElementById('noConformidadesChart').getContext('2d');
    var noConformidadesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Abiertas', 'Cerradas'],
            datasets: [{
                data: [{{ no_conformidades_abiertas }}, {{ no_conformidades_cerradas }}],
                backgroundColor: ['#FF6384', '#36A2EB']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Configuración del gráfico de Satisfacción del Cliente
    var ctxSatisfaccion = document.getElementById('satisfaccionChart').getContext('2d');
    var satisfaccionChart = new Chart(ctxSatisfaccion, {
        type: 'bar',
        data: {
            labels: {{ puntuaciones_meses_labels | tojson }},
            datasets: [{
                label: 'Puntuación de Satisfacción (Promedio)',
                data: {{ puntuaciones_meses_data | tojson }},
                backgroundColor: '#4CAF50'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10
                }
            }
        }
    });
</script>
{% endblock %}
